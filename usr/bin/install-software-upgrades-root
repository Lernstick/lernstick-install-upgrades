#!/bin/sh

# support for i18n and L10n
. gettext.sh
export TEXTDOMAIN=install-software-upgrades

RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

auplink_check()
{
	# check if auplink is necessary and possible
	if grep -q "aufs / aufs" /proc/mounts
	then
		if [ ! -e /sbin/auplink ]
		then
			echo "$(gettext "WARNING: /sbin/auplink not found. Can't clean up file system. Please install the package \"aufs-tools\".\nPress ENTER to continue...")"
			read blah
		fi
	fi
}

cleanup_fs_and_cache()
{
	# FIXME:
	# auplink flushing crashes much too often (between 5-10 % of all test runs
	# crashed the kernel).
	# Therefore we leave out the auplink part for the time being...

	## clean up aufs pseudo links
	#if grep -q "aufs / aufs" /proc/mounts
	#then
	#	if [ -e /sbin/auplink ]
	#	then
	#		echo "$(gettext "Cleaning up file system, please wait...")"
	#		/sbin/auplink / flush
	#	fi
	#fi

	# empty the package cache
	apt-get clean
}

# FIXME:
# as stated above, auplink is too crashy, therefore disabled for now...
## cleanup before and after installing upgrades
#auplink_check

echo "${RED}"
cleanup_fs_and_cache
echo "${NC}"

apt upgrade -y

echo "${GREEN}"
cleanup_fs_and_cache
